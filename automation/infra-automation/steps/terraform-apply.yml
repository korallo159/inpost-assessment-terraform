parameters:
  backend_config: ''
  artifact_name: ''
  tf_working_dir: 'terraform'
  tf_version: '1.12.2'

steps:
  - checkout: self

  - template: terraform-install.yml
    parameters:
      tf_version: ${{ parameters.tf_version }}

  - download: current
    artifact: ${{ parameters.artifact_name }}

  - bash: |
      set -e
      terraform init -backend-config=../automation/infra-automation/backends/${{ parameters.backend_config }}
      terraform apply -auto-approve $(Pipeline.Workspace)/${{ parameters.artifact_name }}/tfplan
    displayName: "terraform apply"
    workingDirectory: ${{ parameters.tf_working_dir }}
    env:
      ARM_CLIENT_ID: $(ARM_CLIENT_ID)
      ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
      ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
      ARM_TENANT_ID: $(ARM_TENANT_ID) 